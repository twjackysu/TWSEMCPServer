name: TWSE API E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©æ—©ä¸Š 9 é»åŸ·è¡Œ (UTC 1:00 = å°ç£æ™‚é–“ 9:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      test_scope:
        description: 'æ¸¬è©¦ç¯„åœ'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - esg
          - api_client

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
    
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --system -r requirements-dev.txt
        uv sync
    
    - name: ğŸ§ª Run all tests
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == '' }}
      run: |
        pytest tests/ -v --tb=short --cov=tools --cov=utils --cov-report=xml --cov-report=term
    
    - name: ğŸ§ª Run ESG API tests only
      if: ${{ github.event.inputs.test_scope == 'esg' }}
      run: |
        pytest tests/e2e/test_esg_api.py -v --tb=short
    
    - name: ğŸ§ª Run API client tests only
      if: ${{ github.event.inputs.test_scope == 'api_client' }}
      run: |
        pytest tests/test_api_client.py -v --tb=short
    
    - name: ğŸ“Š Upload coverage to Codecov
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == '' }}
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
    
    - name: ğŸ’¬ Create issue on failure
      if: failure() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'âš ï¸ TWSE API Schema Change Detected';
          const body = `
          ## æ¸¬è©¦å¤±æ•—é€šçŸ¥
          
          E2E æ¸¬è©¦å¤±æ•—ï¼Œå¯èƒ½åŸå› ï¼š
          - è­‰äº¤æ‰€ API schema å·²è®Šæ›´
          - API ç«¯é»ç„¡æ³•è¨ªå•
          - è³‡æ–™æ ¼å¼ä¸ç¬¦åˆé æœŸ
          
          ### æ¸¬è©¦è©³æƒ…
          - **è§¸ç™¼æ–¹å¼**: ${context.eventName}
          - **åˆ†æ”¯**: ${context.ref}
          - **æäº¤**: ${context.sha}
          - **åŸ·è¡Œæ™‚é–“**: ${new Date().toISOString()}
          
          è«‹æª¢æŸ¥ [æ¸¬è©¦æ—¥èªŒ](${context.payload.repository.html_url}/actions/runs/${context.runId}) ä»¥äº†è§£è©³ç´°è³‡è¨Šã€‚
          
          ### å»ºè­°è¡Œå‹•
          1. æª¢æŸ¥è­‰äº¤æ‰€ API æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°
          2. æŸ¥çœ‹æ¸¬è©¦æ—¥èªŒä¸­çš„éŒ¯èª¤è¨Šæ¯
          3. æ›´æ–°ç›¸é—œçš„å·¥å…·å‡½æ•¸å’Œæ¸¬è©¦
          4. æ›´æ–° API_TODO.md æ–‡ä»¶
          `;
          
          // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'api-change'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['api-change', 'bug', 'automated']
            });
          } else {
            // æ›´æ–°ç¾æœ‰ issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `æ¸¬è©¦å†æ¬¡å¤±æ•— (${new Date().toISOString()})\n\næŸ¥çœ‹ [æœ€æ–°æ¸¬è©¦æ—¥èªŒ](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });
          }
    
    - name: âœ… Comment on success after previous failure
      if: success() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          // é—œé–‰ç›¸é—œçš„ issueï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'api-change'
          });
          
          for (const issue of issues.data) {
            if (issue.title.includes('TWSE API Schema Change Detected')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… æ¸¬è©¦å·²æ¢å¾©æ­£å¸¸ï¼Œå•é¡Œå·²è§£æ±ºã€‚'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
          }
